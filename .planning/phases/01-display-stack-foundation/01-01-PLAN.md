---
phase: 01-display-stack-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cobrowse/setup/cobrowse-setup.sh
  - cobrowse/setup/configure-display.sh
  - cobrowse/systemd/xvfb@.service
  - cobrowse/systemd/tigervnc@.service
  - cobrowse/systemd/novnc@.service
  - cobrowse/systemd/chromium-cdp@.service
autonomous: true

must_haves:
  truths:
    - "cobrowse-setup.sh installs Xvfb, VNC server, noVNC, websockify, and Chromium on Ubuntu 24.04"
    - "cobrowse-setup.sh is idempotent — safe to run multiple times without errors"
    - "Systemd service templates accept display number as parameter (xvfb@99, etc.)"
    - "Chromium service uses --user-data-dir and --remote-debugging-port=9222"
    - "All services have ExecStartPre validation and restart limits (StartLimitBurst=5)"
  artifacts:
    - path: "cobrowse/setup/cobrowse-setup.sh"
      provides: "One-shot installation of entire display stack"
      contains: "apt-get install"
    - path: "cobrowse/setup/configure-display.sh"
      provides: "Display number calculation and env file generation"
      contains: "DISPLAY_NUM"
    - path: "cobrowse/systemd/xvfb@.service"
      provides: "Xvfb virtual framebuffer systemd template"
      contains: "ExecStart=/usr/bin/Xvfb"
    - path: "cobrowse/systemd/tigervnc@.service"
      provides: "TigerVNC server systemd template"
      contains: "ExecStart="
    - path: "cobrowse/systemd/novnc@.service"
      provides: "noVNC + websockify systemd template"
      contains: "websockify"
    - path: "cobrowse/systemd/chromium-cdp@.service"
      provides: "Chromium with CDP systemd template"
      contains: "remote-debugging-port"
  key_links:
    - from: "cobrowse/setup/cobrowse-setup.sh"
      to: "cobrowse/systemd/*.service"
      via: "copies service files to ~/.config/systemd/user/"
      pattern: "cp.*systemd"
    - from: "cobrowse/systemd/chromium-cdp@.service"
      to: "cobrowse/systemd/xvfb@.service"
      via: "After= and Requires= dependency"
      pattern: "Requires=xvfb"
---

<objective>
Create the installation script and systemd service templates for the complete display stack (Xvfb, VNC, noVNC, Chromium with CDP).

Purpose: This is the foundation — everything else depends on packages being installed and services being defined. The setup script must work on a fresh Ubuntu 24.04 container and be safe to re-run.

Output: cobrowse-setup.sh that installs all packages and deploys systemd service files; configure-display.sh that calculates container-specific display numbers; four systemd service template files.
</objective>

<execution_context>
@/home/dev/.claude/get-shit-done/workflows/execute-plan.md
@/home/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-display-stack-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create systemd service templates for all display stack components</name>
  <files>
    cobrowse/systemd/xvfb@.service
    cobrowse/systemd/tigervnc@.service
    cobrowse/systemd/novnc@.service
    cobrowse/systemd/chromium-cdp@.service
  </files>
  <action>
Create four systemd user service template files in cobrowse/systemd/. These are parameterized templates (the @.service pattern) that accept a display number or project name as the instance parameter (%i).

**xvfb@.service** — Virtual framebuffer:
- Type=simple
- ExecStartPre: validate /usr/bin/Xvfb exists (`/usr/bin/test -x /usr/bin/Xvfb`)
- ExecStart: `/usr/bin/Xvfb :%i -screen 0 1920x1080x24 -ac +extension GLX +render -noreset`
- Restart=on-failure, RestartSec=10s
- StartLimitIntervalSec=300, StartLimitBurst=5
- WantedBy=default.target

**tigervnc@.service** — VNC server for display:
- After=xvfb@%i.service, Requires=xvfb@%i.service
- ExecStartPre: validate xdpyinfo can reach display :%i
- CRITICAL: TigerVNC's `vncserver` creates its own X server and CANNOT export an existing Xvfb display. Instead, use `x0vncserver` (part of tigervnc-scraping-server package) which connects to an existing X display: `x0vncserver -display :%i -rfbport 59%i -SecurityTypes None`
- If x0vncserver is not available, fall back to x11vnc: `x11vnc -display :%i -rfbport 59%i -nopw -forever -shared`
- The service template should use x0vncserver as the primary approach since it's the TigerVNC component designed for this use case
- Restart=on-failure, RestartSec=10s
- StartLimitIntervalSec=300, StartLimitBurst=5

**novnc@.service** — noVNC web client via websockify:
- After=tigervnc@%i.service, Requires=tigervnc@%i.service
- ExecStartPre: check VNC port is listening (`/bin/bash -c 'timeout 5 bash -c "until lsof -i :59%i >/dev/null 2>&1; do sleep 0.5; done"'`)
- ExecStart: `/usr/bin/websockify --web=/usr/share/novnc 6080 localhost:59%i`
- NOTE: The VNC port is 5900 + display_num. For display :99, VNC port is 5999. Use format 59%i which for %i=99 gives 5999.
- Actually the port math doesn't work cleanly with %i substitution for numbers >9. Use a fixed convention: for display :99, VNC port 5999, noVNC port 6080. The novnc service takes the display number as %i and constructs: `websockify --web=/usr/share/novnc 6080 localhost:59%i`
- CORRECTION on port math: For display :99, the standard VNC port is 5900+99=5999. The template should use `59%i` only if %i is two digits. Since we're targeting display :99 specifically in Phase 1 (dynamic display comes later), hardcode the math as `59%i` which gives `5999` for %i=99. This works for any two-digit display number.
- Restart=on-failure, RestartSec=10s

**chromium-cdp@.service** — Chromium browser with CDP:
- After=xvfb@%i.service, Requires=xvfb@%i.service (depends on display, not VNC)
- Environment="DISPLAY=:%i"
- ExecStartPre: validate chromium-browser exists AND display is responsive
- ExecStart: `/usr/bin/chromium-browser --remote-debugging-port=9222 --user-data-dir=/home/dev/.cobrowse/chrome-profile --no-first-run --no-default-browser-check --disable-gpu --disable-dev-shm-usage --disable-software-rasterizer --window-size=1920,1080`
- CRITICAL: Must include --user-data-dir with a non-default path (Chrome 136+ requirement for CDP)
- Restart=on-failure, RestartSec=10s
- StartLimitIntervalSec=300, StartLimitBurst=5

Port conventions for Phase 1 (single container):
- Display: :99
- VNC: 5999 (5900 + 99)
- noVNC/websockify: 6080
- CDP: 9222
  </action>
  <verify>
Validate service files have correct syntax:
```bash
# Check all 4 files exist
ls cobrowse/systemd/*.service | wc -l  # Should be 4

# Verify critical patterns
grep -l "ExecStartPre" cobrowse/systemd/*.service | wc -l  # Should be 4
grep -l "StartLimitBurst" cobrowse/systemd/*.service | wc -l  # Should be at least 3
grep "user-data-dir" cobrowse/systemd/chromium-cdp@.service  # Must exist
grep "remote-debugging-port=9222" cobrowse/systemd/chromium-cdp@.service  # Must exist
```
  </verify>
  <done>Four systemd service template files exist with ExecStartPre validation, restart limits, proper dependency ordering (chromium After xvfb, vnc After xvfb, novnc After vnc), and Chromium configured with both --user-data-dir and --remote-debugging-port=9222.</done>
</task>

<task type="auto">
  <name>Task 2: Create setup script and display configuration</name>
  <files>
    cobrowse/setup/cobrowse-setup.sh
    cobrowse/setup/configure-display.sh
  </files>
  <action>
**cobrowse-setup.sh** — Main installation script. Must be idempotent and work for non-root user with sudo.

Structure:
1. Shebang + set -euo pipefail
2. Print banner with version info
3. Check Ubuntu 24.04 (`lsb_release -cs` should be "noble")
4. Package installation (idempotent via apt-get install -y):
   - xvfb (likely already installed, skip gracefully)
   - tigervnc-scraping-server (provides x0vncserver for exporting existing X displays)
   - x11vnc (fallback if tigervnc-scraping-server not available)
   - novnc
   - python3-websockify (provides websockify)
   - python3-numpy (websockify performance)
   - chromium-browser
   - x11-utils (provides xdpyinfo)
   - lsof curl net-tools (debugging tools)
5. Create directory structure:
   - /home/dev/.cobrowse/chrome-profile/
   - /home/dev/.cobrowse/logs/
   - /home/dev/.config/systemd/user/ (if not exists)
6. Copy systemd service files from cobrowse/systemd/ to ~/.config/systemd/user/
7. Run `systemctl --user daemon-reload`
8. Enable lingering for the dev user: `sudo loginctl enable-linger dev` (so user services persist after logout)
9. Run configure-display.sh to generate display.env
10. Print summary of what was installed and next steps

Idempotency rules:
- apt-get install -y is naturally idempotent
- mkdir -p is naturally idempotent
- cp overwrites existing files (updates services on re-run)
- daemon-reload is safe to re-run
- enable-linger is safe to re-run

**configure-display.sh** — Calculate display number and write env file.

For Phase 1 (single container), use display :99 as default. The script calculates a container-specific offset but defaults to :99 if no conflict detected.

Structure:
1. Calculate display number from hostname hash (for future multi-container)
2. Check if calculated display is available (xdpyinfo test)
3. Fall back to :99 if no conflicts
4. Write /home/dev/.cobrowse/display.env with:
   - DISPLAY=:99
   - VNC_PORT=5999
   - NOVNC_PORT=6080
   - CDP_PORT=9222
5. Make the env file sourceable (KEY=VALUE format)

Important: The script should determine the path to the service files relative to its own location, using `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` and then referencing `"$SCRIPT_DIR/../systemd/"` for the service files.
  </action>
  <verify>
```bash
# Check scripts exist and are executable patterns
head -1 cobrowse/setup/cobrowse-setup.sh  # Should be #!/bin/bash
head -1 cobrowse/setup/configure-display.sh  # Should be #!/bin/bash

# Verify idempotency markers
grep -c "apt-get install -y" cobrowse/setup/cobrowse-setup.sh  # At least 1
grep "mkdir -p" cobrowse/setup/cobrowse-setup.sh  # Should exist
grep "daemon-reload" cobrowse/setup/cobrowse-setup.sh  # Should exist
grep "enable-linger" cobrowse/setup/cobrowse-setup.sh  # Should exist

# Verify display.env generation
grep "DISPLAY=" cobrowse/setup/configure-display.sh  # Should exist
grep "VNC_PORT=" cobrowse/setup/configure-display.sh  # Should exist
```
  </verify>
  <done>cobrowse-setup.sh installs all packages, creates directories, deploys systemd services, enables lingering, and runs display configuration. configure-display.sh generates display.env with port assignments. Both scripts use set -euo pipefail and are idempotent.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All 6 files exist in cobrowse/setup/ and cobrowse/systemd/
2. Service files reference correct binaries and have proper dependency chains
3. Setup script references correct package names for Ubuntu 24.04
4. chromium-cdp@.service includes both --user-data-dir and --remote-debugging-port=9222
5. All services have ExecStartPre validation and StartLimitBurst restart limits
</verification>

<success_criteria>
- 4 systemd service template files with proper dependency ordering and validation
- Setup script that installs entire stack idempotently on Ubuntu 24.04
- Display configuration script that generates sourceable env file
- All Chromium flags correct for Chrome 136+ CDP requirement
</success_criteria>

<output>
After completion, create `.planning/phases/01-display-stack-foundation/01-01-SUMMARY.md`
</output>
